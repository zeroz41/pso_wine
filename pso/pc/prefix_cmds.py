import os
import subprocess
import pathlib
import urllib.request
import select
import pty
import errno
import sys
import shutil
import time
import signal
from contextlib import contextmanager
import tarfile
from cmd_runner import CommandRunner
import platform
import re

# made by zeroz - tj

class WineSetupError(Exception):
    """Custom exception for Wine setup errors"""
    pass

class WineUtils(CommandRunner):
    def __init__(self, prefix_path="~/.local/share/ephinea-prefix"):
        self.prefix_path = os.path.expanduser(prefix_path)
        self.original_env = os.environ.copy()
        self.env = os.environ.copy()
        self.env["WINEPREFIX"] = self.prefix_path
        self.env["WINEDEBUG"] = "-all"
    
    def run_command(self, command, timeout=60, env=None, capture_output=False):
        if env is None:
            env = self.env
        return super().run_command(command, timeout=timeout, env=env, capture_output=capture_output)

        
    # hacky gui suppression methods. Allow us to not show windows when we want, like wine updating or install. WINE GUIS   
    # but its fun at least 
    def suppress_gui(self):
        """Enable GUI suppression for installation/setup"""
        print("Current environment before suppression:")
        for key in sorted(self.env.keys()):
            if key.startswith('WINE'):
                print(f"{key}={self.env[key]}")
        
        self.env["WINEDLLOVERRIDES"] = "mscoree=d;winemenubuilder.exe=d"
        self.env["DISPLAY"] = ""
        
    def enable_gui(self):
        """Enable GUI for game execution"""
        print("Current environment before GUI enable:")
        for key in sorted(self.env.keys()):
            if key.startswith('WINE'):
                print(f"{key}={self.env[key]}")
                
        # Restore original environment except WINEPREFIX and WINEDEBUG
        self.env = self.original_env.copy()
        self.env["WINEPREFIX"] = self.prefix_path
        self.env["WINEDEBUG"] = "-all"
        
        print("Environment after restore:")
        for key in sorted(self.env.keys()):
            if key.startswith('WINE'):
                print(f"{key}={self.env[key]}")
        
    def execute_game(self, command):
        """Execute the game with GUI enabled"""
        self.enable_gui()
        return self.run_command(command, timeout=None)

    def check_wine_installed(self):
        """Check if Wine is installed on the system"""
        try:
            result = self.run_command(["wine", "--version"], timeout=10)
            return result == 0
        except Exception:
            return False

    def check_system_mono(self):
        """Check if Wine Mono is installed system-wide"""
        possible_paths = [
            "/usr/share/wine/mono",
            "/opt/wine/mono",
            "/usr/lib/wine/mono",
        ]
        
        # Check package managers
        package_name = "wine-mono"  # Same name across distros
        if self.check_package_installed(package_name):
            print("Found wine-mono system package installed")
            return True

        # Check system paths as fallback
        return any(pathlib.Path(path).exists() for path in possible_paths)

    def download_file(self, url, destination):
        """Download a file from URL to destination"""
        print(f"Downloading {url}...")
        temp_file = f"{destination}.tmp"
        try:
            urllib.request.urlretrieve(url, temp_file)
            shutil.move(temp_file, destination)
            print("Download completed!")
            return True
        except Exception as e:
            print(f"Download failed: {e}")
            if os.path.exists(temp_file):
                os.remove(temp_file)
            return False
        
    def get_cache_dir(self):
        if platform.system() == "Linux":
            return os.path.expanduser("~/.cache/pso_wine")
        elif platform.system() == "Darwin":
            return os.path.expanduser("~/Library/Caches/pso_wine")
        
        return None 

    def install_mono(self, has_system_mono=None):
        """Download and install Wine Mono in the prefix"""
        # Use cached system mono check result if provided
        if has_system_mono is None:
            has_system_mono = self.check_system_mono()
            
        cache_dir = self.get_cache_dir()
        os.makedirs(cache_dir, exist_ok=True)

        # Try system Mono first if available
        if has_system_mono:
            print("\nAttempting to configure system Mono...")
            if self._verify_mono_installation(has_system_mono):
                print("System Mono configured successfully!")
                return True
            print("System Mono verification failed, falling back to MSI installation...")
            has_system_mono = False  # Force MSI path

        # MSI Installation path
        mono_version = "9.3.0"
        mono_filename = f"wine-mono-{mono_version}-x86.msi"
        mono_url = f"https://dl.winehq.org/wine/wine-mono/{mono_version}/{mono_filename}"
        mono_path = os.path.join(cache_dir, mono_filename)

        try:
            # Download if needed
            have_valid_installer = os.path.exists(mono_path) and os.path.getsize(mono_path) >= 1024
            if not have_valid_installer:
                if not self.download_file(mono_url, mono_path):
                    return False

            print("Installing Wine Mono via MSI...")
            
            # Kill any existing wine processes and wait
            self.run_command(["wineserver", "-k"], timeout=10)
            
            # Do a clean prefix initialization
            self.run_command(["wineboot", "-i"], timeout=30)
            
            # Run the MSI installer with a longer timeout
            print("Running MSI installation...")
            result = self.run_command(
                ["wine", "msiexec", "/i", mono_path],
                timeout=500  # long timeout
            )
            
            if result != 0:
                print("MSI installation failed")
                return False
                
            # Final verification
            if self._verify_mono_installation(False):  # Pass False to force MSI verification path
                print("Wine Mono MSI installation completed successfully!")
                return True
            else:
                print("Wine Mono MSI installation could not be verified")
                return False

        except Exception as e:
            print(f"Error during Mono installation: {e}")
            return False
        
    #Temporary resetting of env vars back to default. Useful since we disabled mono popups on install too.    
    @contextmanager
    def temporary_gui_enable(self):
        """Temporarily restore GUI settings for tests/verification"""
        old_overrides = self.env.get("WINEDLLOVERRIDES")
        old_display = self.env.get("DISPLAY")
        
        # Clear the suppressions
        if "WINEDLLOVERRIDES" in self.env:
            del self.env["WINEDLLOVERRIDES"]
        if "DISPLAY" in self.env:
            del self.env["DISPLAY"]
            
        try:
            yield
        finally:
            # Restore previous state
            if old_overrides:
                self.env["WINEDLLOVERRIDES"] = old_overrides
            if old_display is not None:
                self.env["DISPLAY"] = old_display

    def _verify_mono_installation(self, has_system_mono=None):
        
        exe_bytes = bytes([
            0x4D, 0x5A, 0x90, 0x00, 0x03, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00,
            0xFF, 0xFF, 0x00, 0x00, 0xB8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x80, 0x00, 0x00, 0x00, 0x0E, 0x1F, 0xBA, 0x0E, 0x00, 0xB4, 0x09, 0xCD,
            0x21, 0xB8, 0x01, 0x4C, 0xCD, 0x21, 0x54, 0x68, 0x69, 0x73, 0x20, 0x70,
            0x72, 0x6F, 0x67, 0x72, 0x61, 0x6D, 0x20, 0x63, 0x61, 0x6E, 0x6E, 0x6F,
            0x74, 0x20, 0x62, 0x65, 0x20, 0x72, 0x75, 0x6E, 0x20, 0x69, 0x6E, 0x20,
            0x44, 0x4F, 0x53, 0x20, 0x6D, 0x6F, 0x64, 0x65, 0x2E, 0x0D, 0x0D, 0x0A,
            0x24, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x50, 0x45, 0x00, 0x00,
            0x4C, 0x01, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0xE0, 0x00, 0x02, 0x01, 0x0B, 0x01, 0x08, 0x00,
            0x00, 0x04, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0xEE, 0x22, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00,
            0x00, 0x00, 0x40, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00,
            0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x40, 0x85, 0x00, 0x00, 0x10, 0x00,
            0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x10, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0xA0, 0x22, 0x00, 0x00, 0x4B, 0x00, 0x00, 0x00,
            0x00, 0x40, 0x00, 0x00, 0xD8, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x60, 0x00, 0x00, 0x0C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00,
            0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x08, 0x20, 0x00, 0x00, 0x48, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x2E, 0x74, 0x65, 0x78, 0x74, 0x00, 0x00, 0x00,
            0xF4, 0x02, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00,
            0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x60, 0x2E, 0x72, 0x73, 0x72,
            0x63, 0x00, 0x00, 0x00, 0xD8, 0x02, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00,
            0x00, 0x04, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x40,
            0x2E, 0x72, 0x65, 0x6C, 0x6F, 0x63, 0x00, 0x00, 0x0C, 0x00, 0x00, 0x00,
            0x00, 0x60, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x0A, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x40, 0x00, 0x00, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xD0, 0x22, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x48, 0x00, 0x00, 0x00, 0x02, 0x00, 0x05, 0x00,
            0x64, 0x20, 0x00, 0x00, 0x38, 0x02, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
            0x02, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x1E, 0x02, 0x28, 0x02, 0x00, 0x00, 0x0A, 0x2A,
            0x2E, 0x72, 0x01, 0x00, 0x00, 0x70, 0x28, 0x01, 0x00, 0x00, 0x0A, 0x2A,
            0x42, 0x53, 0x4A, 0x42, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x0C, 0x00, 0x00, 0x00, 0x76, 0x34, 0x2E, 0x30, 0x2E, 0x33, 0x30, 0x33,
            0x31, 0x39, 0x00, 0x00, 0x00, 0x00, 0x05, 0x00, 0x6C, 0x00, 0x00, 0x00,
            0xD0, 0x00, 0x00, 0x00, 0x23, 0x7E, 0x00, 0x00, 0x3C, 0x01, 0x00, 0x00,
            0x90, 0x00, 0x00, 0x00, 0x23, 0x53, 0x74, 0x72, 0x69, 0x6E, 0x67, 0x73,
            0x00, 0x00, 0x00, 0x00, 0xCC, 0x01, 0x00, 0x00, 0x24, 0x00, 0x00, 0x00,
            0x23, 0x55, 0x53, 0x00, 0xF0, 0x01, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00,
            0x23, 0x47, 0x55, 0x49, 0x44, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00,
            0x38, 0x00, 0x00, 0x00, 0x23, 0x42, 0x6C, 0x6F, 0x62, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x10, 0x47, 0x14, 0x00, 0x00,
            0x09, 0x00, 0x00, 0x00, 0x00, 0xFA, 0x01, 0x33, 0x00, 0x16, 0x00, 0x00,
            0x01, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
            0x02, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
            0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x86, 0x00,
            0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x00, 0x0F, 0x00, 0x17, 0x00,
            0x06, 0x00, 0x28, 0x00, 0x17, 0x00, 0x06, 0x00, 0x3F, 0x00, 0x5D, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00,
            0x01, 0x00, 0x00, 0x00, 0x10, 0x00, 0x0A, 0x00, 0x00, 0x00, 0x09, 0x00,
            0x01, 0x00, 0x01, 0x00, 0x50, 0x20, 0x00, 0x00, 0x00, 0x00, 0x86, 0x18,
            0x2F, 0x00, 0x06, 0x00, 0x01, 0x00, 0x58, 0x20, 0x00, 0x00, 0x00, 0x00,
            0x91, 0x00, 0x35, 0x00, 0x0A, 0x00, 0x01, 0x00, 0x09, 0x00, 0x1E, 0x00,
            0x01, 0x00, 0x11, 0x00, 0x2F, 0x00, 0x06, 0x00, 0x19, 0x00, 0x2F, 0x00,
            0x06, 0x00, 0x2E, 0x00, 0x1B, 0x00, 0x0E, 0x00, 0x04, 0x80, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x3A, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x2D, 0x00, 0x7D, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x3C, 0x4D, 0x6F, 0x64, 0x75, 0x6C, 0x65,
            0x3E, 0x00, 0x54, 0x65, 0x73, 0x74, 0x00, 0x43, 0x6F, 0x6E, 0x73, 0x6F,
            0x6C, 0x65, 0x00, 0x53, 0x79, 0x73, 0x74, 0x65, 0x6D, 0x00, 0x57, 0x72,
            0x69, 0x74, 0x65, 0x4C, 0x69, 0x6E, 0x65, 0x00, 0x4F, 0x62, 0x6A, 0x65,
            0x63, 0x74, 0x00, 0x2E, 0x63, 0x74, 0x6F, 0x72, 0x00, 0x4D, 0x61, 0x69,
            0x6E, 0x00, 0x74, 0x65, 0x73, 0x74, 0x00, 0x52, 0x75, 0x6E, 0x74, 0x69,
            0x6D, 0x65, 0x43, 0x6F, 0x6D, 0x70, 0x61, 0x74, 0x69, 0x62, 0x69, 0x6C,
            0x69, 0x74, 0x79, 0x41, 0x74, 0x74, 0x72, 0x69, 0x62, 0x75, 0x74, 0x65,
            0x00, 0x53, 0x79, 0x73, 0x74, 0x65, 0x6D, 0x2E, 0x52, 0x75, 0x6E, 0x74,
            0x69, 0x6D, 0x65, 0x2E, 0x43, 0x6F, 0x6D, 0x70, 0x69, 0x6C, 0x65, 0x72,
            0x53, 0x65, 0x72, 0x76, 0x69, 0x63, 0x65, 0x73, 0x00, 0x6D, 0x73, 0x63,
            0x6F, 0x72, 0x6C, 0x69, 0x62, 0x00, 0x74, 0x65, 0x73, 0x74, 0x2E, 0x65,
            0x78, 0x65, 0x00, 0x00, 0x00, 0x21, 0x48, 0x00, 0x65, 0x00, 0x6C, 0x00,
            0x6C, 0x00, 0x6F, 0x00, 0x20, 0x00, 0x66, 0x00, 0x72, 0x00, 0x6F, 0x00,
            0x6D, 0x00, 0x20, 0x00, 0x2E, 0x00, 0x4E, 0x00, 0x45, 0x00, 0x54, 0x00,
            0x21, 0x00, 0x00, 0x00, 0xFD, 0xD8, 0x4D, 0xE6, 0xC9, 0x27, 0xC8, 0x49,
            0x87, 0xAB, 0x26, 0xB7, 0xFB, 0xF0, 0xC4, 0xD7, 0x00, 0x04, 0x00, 0x01,
            0x01, 0x0E, 0x03, 0x20, 0x00, 0x01, 0x03, 0x00, 0x00, 0x01, 0x1E, 0x01,
            0x00, 0x01, 0x00, 0x54, 0x02, 0x16, 0x57, 0x72, 0x61, 0x70, 0x4E, 0x6F,
            0x6E, 0x45, 0x78, 0x63, 0x65, 0x70, 0x74, 0x69, 0x6F, 0x6E, 0x54, 0x68,
            0x72, 0x6F, 0x77, 0x73, 0x01, 0x08, 0xB7, 0x7A, 0x5C, 0x56, 0x19, 0x34,
            0xE0, 0x89, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC8, 0x22, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xDE, 0x22, 0x00, 0x00,
            0x00, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0xD0, 0x22, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x5F, 0x43,
            0x6F, 0x72, 0x45, 0x78, 0x65, 0x4D, 0x61, 0x69, 0x6E, 0x00, 0x6D, 0x73,
            0x63, 0x6F, 0x72, 0x65, 0x65, 0x2E, 0x64, 0x6C, 0x6C, 0x00, 0x00, 0x00,
            0x00, 0x00, 0xFF, 0x25, 0x00, 0x20, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x01, 0x00, 0x10, 0x00, 0x00, 0x00, 0x18, 0x00, 0x00, 0x80,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00, 0x30, 0x00, 0x00, 0x80,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x48, 0x00, 0x00, 0x00,
            0x58, 0x40, 0x00, 0x00, 0x80, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x80, 0x02, 0x34, 0x00, 0x00, 0x00, 0x56, 0x00,
            0x53, 0x00, 0x5F, 0x00, 0x56, 0x00, 0x45, 0x00, 0x52, 0x00, 0x53, 0x00,
            0x49, 0x00, 0x4F, 0x00, 0x4E, 0x00, 0x5F, 0x00, 0x49, 0x00, 0x4E, 0x00,
            0x46, 0x00, 0x4F, 0x00, 0x00, 0x00, 0x00, 0x00, 0xBD, 0x04, 0xEF, 0xFE,
            0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x44, 0x00, 0x00, 0x00, 0x01, 0x00, 0x56, 0x00, 0x61, 0x00, 0x72, 0x00,
            0x46, 0x00, 0x69, 0x00, 0x6C, 0x00, 0x65, 0x00, 0x49, 0x00, 0x6E, 0x00,
            0x66, 0x00, 0x6F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0x00, 0x04, 0x00,
            0x00, 0x00, 0x54, 0x00, 0x72, 0x00, 0x61, 0x00, 0x6E, 0x00, 0x73, 0x00,
            0x6C, 0x00, 0x61, 0x00, 0x74, 0x00, 0x69, 0x00, 0x6F, 0x00, 0x6E, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x7F, 0x00, 0xB0, 0x04, 0xE0, 0x01, 0x00, 0x00,
            0x01, 0x00, 0x53, 0x00, 0x74, 0x00, 0x72, 0x00, 0x69, 0x00, 0x6E, 0x00,
            0x67, 0x00, 0x46, 0x00, 0x69, 0x00, 0x6C, 0x00, 0x65, 0x00, 0x49, 0x00,
            0x6E, 0x00, 0x66, 0x00, 0x6F, 0x00, 0x00, 0x00, 0xBC, 0x01, 0x00, 0x00,
            0x01, 0x00, 0x30, 0x00, 0x30, 0x00, 0x37, 0x00, 0x66, 0x00, 0x30, 0x00,
            0x34, 0x00, 0x62, 0x00, 0x30, 0x00, 0x00, 0x00, 0x1C, 0x00, 0x02, 0x00,
            0x01, 0x00, 0x43, 0x00, 0x6F, 0x00, 0x6D, 0x00, 0x6D, 0x00, 0x65, 0x00,
            0x6E, 0x00, 0x74, 0x00, 0x73, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00,
            0x24, 0x00, 0x02, 0x00, 0x01, 0x00, 0x43, 0x00, 0x6F, 0x00, 0x6D, 0x00,
            0x70, 0x00, 0x61, 0x00, 0x6E, 0x00, 0x79, 0x00, 0x4E, 0x00, 0x61, 0x00,
            0x6D, 0x00, 0x65, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00,
            0x2C, 0x00, 0x02, 0x00, 0x01, 0x00, 0x46, 0x00, 0x69, 0x00, 0x6C, 0x00,
            0x65, 0x00, 0x44, 0x00, 0x65, 0x00, 0x73, 0x00, 0x63, 0x00, 0x72, 0x00,
            0x69, 0x00, 0x70, 0x00, 0x74, 0x00, 0x69, 0x00, 0x6F, 0x00, 0x6E, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x30, 0x00, 0x08, 0x00,
            0x01, 0x00, 0x46, 0x00, 0x69, 0x00, 0x6C, 0x00, 0x65, 0x00, 0x56, 0x00,
            0x65, 0x00, 0x72, 0x00, 0x73, 0x00, 0x69, 0x00, 0x6F, 0x00, 0x6E, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x30, 0x00, 0x2E, 0x00, 0x30, 0x00, 0x2E, 0x00,
            0x30, 0x00, 0x2E, 0x00, 0x30, 0x00, 0x00, 0x00, 0x2C, 0x00, 0x05, 0x00,
            0x01, 0x00, 0x49, 0x00, 0x6E, 0x00, 0x74, 0x00, 0x65, 0x00, 0x72, 0x00,
            0x6E, 0x00, 0x61, 0x00, 0x6C, 0x00, 0x4E, 0x00, 0x61, 0x00, 0x6D, 0x00,
            0x65, 0x00, 0x00, 0x00, 0x74, 0x00, 0x65, 0x00, 0x73, 0x00, 0x74, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x28, 0x00, 0x02, 0x00, 0x01, 0x00, 0x4C, 0x00,
            0x65, 0x00, 0x67, 0x00, 0x61, 0x00, 0x6C, 0x00, 0x43, 0x00, 0x6F, 0x00,
            0x70, 0x00, 0x79, 0x00, 0x72, 0x00, 0x69, 0x00, 0x67, 0x00, 0x68, 0x00,
            0x74, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x2C, 0x00, 0x02, 0x00,
            0x01, 0x00, 0x4C, 0x00, 0x65, 0x00, 0x67, 0x00, 0x61, 0x00, 0x6C, 0x00,
            0x54, 0x00, 0x72, 0x00, 0x61, 0x00, 0x64, 0x00, 0x65, 0x00, 0x6D, 0x00,
            0x61, 0x00, 0x72, 0x00, 0x6B, 0x00, 0x73, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x20, 0x00, 0x00, 0x00, 0x3C, 0x00, 0x09, 0x00, 0x01, 0x00, 0x4F, 0x00,
            0x72, 0x00, 0x69, 0x00, 0x67, 0x00, 0x69, 0x00, 0x6E, 0x00, 0x61, 0x00,
            0x6C, 0x00, 0x46, 0x00, 0x69, 0x00, 0x6C, 0x00, 0x65, 0x00, 0x6E, 0x00,
            0x61, 0x00, 0x6D, 0x00, 0x65, 0x00, 0x00, 0x00, 0x74, 0x00, 0x65, 0x00,
            0x73, 0x00, 0x74, 0x00, 0x2E, 0x00, 0x65, 0x00, 0x78, 0x00, 0x65, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x24, 0x00, 0x02, 0x00, 0x01, 0x00, 0x50, 0x00,
            0x72, 0x00, 0x6F, 0x00, 0x64, 0x00, 0x75, 0x00, 0x63, 0x00, 0x74, 0x00,
            0x4E, 0x00, 0x61, 0x00, 0x6D, 0x00, 0x65, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x20, 0x00, 0x00, 0x00, 0x28, 0x00, 0x02, 0x00, 0x01, 0x00, 0x50, 0x00,
            0x72, 0x00, 0x6F, 0x00, 0x64, 0x00, 0x75, 0x00, 0x63, 0x00, 0x74, 0x00,
            0x56, 0x00, 0x65, 0x00, 0x72, 0x00, 0x73, 0x00, 0x69, 0x00, 0x6F, 0x00,
            0x6E, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x0C, 0x00, 0x00, 0x00,
            0xF0, 0x32, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
        ])

        if has_system_mono is None:
            has_system_mono = self.check_system_mono()
        
        # Create test directory
        test_dir = os.path.join(self.prefix_path, "drive_c/temp")
        os.makedirs(test_dir, exist_ok=True)
        test_exe_path = os.path.join(test_dir, "monotest.exe")

        # Temporarily enable GUI for the test
        with self.temporary_gui_enable():
            self.run_command(["wineboot", "-i"], timeout=30)
            
            try:
                print(f"Creating test file at {test_exe_path}")
                with open(test_exe_path, "wb") as f:
                    f.write(exe_bytes)
                
                os.chmod(test_exe_path, 0o755)
                
                if not os.path.exists(test_exe_path):
                    print(f"  ✗ Failed to create test file")
                    return False
                    
                file_size = os.path.getsize(test_exe_path)
                print(f"  ✓ Test file created (size: {file_size} bytes)")
                    
                run_result, output = self.run_command(
                    ["wine", test_exe_path],
                    timeout=30,
                    capture_output=True,
                    env=self.env
                )
                
                print(f"  Program output: {output}")
                print("  Program execution details:")
                print(f"    Return code: {run_result}")
                print("    Output:")
                for line in output.splitlines():
                    print(f"      {line}")
                
                if "Hello from .NET!" in output:
                    print("  ✓ Runtime test successful - .NET program executed correctly")
                    if has_system_mono:
                        print("\nSystem Mono verification completed successfully!")
                        return True
                else:
                    print("  ✗ Runtime test failed - program did not produce expected output")
                    if has_system_mono:
                        return False  # Let install_mono() try MSI instead
                        
            except Exception as e:
                print(f"  ✗ Runtime test failed: {e}")
                if has_system_mono:
                    return False  # Let install_mono() try MSI instead
            finally:
                # Cleanup
                try:
                    if os.path.exists(test_exe_path):
                        os.remove(test_exe_path)
                        print("  ✓ Test file cleaned up")
                except Exception as e:
                    print(f"  ✗ Failed to cleanup test file: {e}")

        # For MSI installations, do additional verification outside the GUI context
        if not has_system_mono:
            verification_passed = True
            
            # Check registry keys for MSI installation
            print("\nChecking .NET Framework registry keys:")
            REQUIRED_REGISTRY_KEYS = [
                "HKLM\\Software\\Microsoft\\NET Framework Setup\\NDP\\v4\\Full",
                "HKLM\\Software\\Microsoft\\NET Framework Setup\\NDP\\v4\\Client",
            ]
            
            registry_found = False
            for key in REQUIRED_REGISTRY_KEYS:
                try:
                    result = self.run_command(
                        ["wine", "reg", "query", key],
                        timeout=10
                    )
                    print(f"  {'✓' if result == 0 else '✗'} {key}")
                    if result == 0:
                        registry_found = True
                except Exception as e:
                    print(f"  ✗ Error checking registry key {key}: {e}")
                    
            if not registry_found:
                print("  ✗ Required .NET Framework registry entries not found")
                verification_passed = False
                    
            # Verify core DLL presence and size
            print("\nChecking critical Mono files:")
            framework_path = os.path.join(self.prefix_path, "drive_c/windows/Microsoft.NET/Framework")
            found_valid_dll = False
            min_dll_size = 100000  # Minimum size in bytes for a valid mscorlib.dll
            
            if os.path.exists(framework_path):
                for folder in os.listdir(framework_path):
                    if folder.startswith('v4.'):
                        dll_path = os.path.join(framework_path, folder, "mscorlib.dll")
                        if os.path.exists(dll_path):
                            dll_size = os.path.getsize(dll_path)
                            exists = dll_size >= min_dll_size
                            print(f"  {'✓' if exists else '✗'} {folder}/mscorlib.dll (size: {dll_size:,} bytes)")
                            if exists:
                                found_valid_dll = True
                        else:
                            print(f"  ✗ {folder}/mscorlib.dll (not found)")
            
            if not found_valid_dll:
                print("  ✗ No valid mscorlib.dll found")
                verification_passed = False
                    
            print(f"\nMono verification {'passed' if verification_passed else 'failed'} all checks")
            return verification_passed
        
        return False
    
    def _get_gecko_version(self):
        """Determine appropriate Gecko version based on Wine version"""
        try:
            # Get Wine version using our new command runner with capture_output
            returncode, output = self.run_command(
                ["wine", "--version"], 
                timeout=10, 
                capture_output=True
            )
            
            if returncode != 0:
                print("Could not determine Wine version, defaulting to Gecko 2.47.4")
                return "2.47.4"

            # Version mapping
            gecko_versions = {
                4.0: "2.47.0",
                5.0: "2.47.1",
                6.0: "2.47.2",
                7.0: "2.47.3",
                8.0: "2.47.4"  # 8.0 and up
            }

            # Find appropriate version
            version_match = re.search(r'wine-(\d+\.\d+)', output)
            if not version_match:
                print("Could not parse Wine version output, defaulting to Gecko 2.47.4")
                return "2.47.4"
            
            wine_ver = float(version_match.group(1))
            
            # Find appropriate version
            selected_version = "2.47.4"  # Default to latest for 8.0+ or unknown versions
            for ver in sorted(gecko_versions.keys()):
                if wine_ver >= ver:
                    selected_version = gecko_versions[ver]
            
            print(f"Selected Gecko version {selected_version} for Wine {wine_ver}")
            return selected_version

        except Exception as e:
            print(f"Error determining Gecko version: {e}, defaulting to 2.47.4")
            return "2.47.4"

    def check_prefix_gecko(self):
        """Check if Wine Gecko is installed in the prefix"""
        try:
            result = self.run_command(
                ["wine", "reg", "query", "HKLM\\Software\\Wine\\MSHTML"],
                timeout=10
            )
            return result == 0
        except Exception:
            return False
        
    def check_system_gecko(self):
        """Check if Wine Gecko is installed system-wide"""
        possible_paths = [
            "/usr/share/wine/gecko",
            "/opt/wine/gecko",
            "/usr/lib/wine/gecko",
        ]
        
        # Check package managers first
        package_name = "wine-gecko"  # Same name across distros
        if self.check_package_installed(package_name):
            print("System Gecko package verification:")
            print("  ✓ Found wine-gecko system package installed")
            return True

        # Check system paths as fallback
        for path in possible_paths:
            if pathlib.Path(path).exists():
                print(f"  ✓ Found Gecko in system path: {path}")
                return True
                
        print("  ✗ No system Gecko installation found")
        return False

    def install_gecko(self, has_system_gecko=None):
        """Download and install Wine Gecko in the prefix"""
        if has_system_gecko is None:
            has_system_gecko = self.check_system_gecko()
            
        cache_dir = self.get_cache_dir()
        os.makedirs(cache_dir, exist_ok=True)

        # Get appropriate Gecko version based on Wine version
        gecko_version = self._get_gecko_version()
        
        gecko_files = [
            f"wine-gecko-{gecko_version}-x86.msi",
            f"wine-gecko-{gecko_version}-x86_64.msi"
        ]
        
        try:
            # Clean slate before install
            self.run_command(["wineserver", "-k"], timeout=10)
            
            for gecko_filename in gecko_files:
                gecko_url = f"https://dl.winehq.org/wine/wine-gecko/{gecko_version}/{gecko_filename}"
                gecko_path = os.path.join(cache_dir, gecko_filename)
                
                # Use existing installer if valid
                have_valid_installer = os.path.exists(gecko_path) and os.path.getsize(gecko_path) >= 1024
                if have_valid_installer:
                    print(f"Using existing installer at {gecko_path}")
                else:
                    if not self.download_file(gecko_url, gecko_path):
                        return False

                print(f"Installing Wine Gecko ({gecko_filename})...")
                result = self.run_command(
                    ["wine", "msiexec", "/i", gecko_path],
                    timeout=None
                )
                
                if result != 0:
                    print(f"MSI installation failed for {gecko_filename}")
                    return False

                # Clean up after each installer
                self.run_command(["wineserver", "-k"], timeout=10)

            # Final verification
            if self._verify_gecko_installation(has_system_gecko):
                print("Wine Gecko installation completed successfully!")
                return True

            print("Wine Gecko installation could not be verified")
            return False

        except Exception as e:
            print(f"Error during Gecko installation: {e}")
            return False
        
    def _verify_gecko_installation(self, has_system_gecko=None):
        """Verify Gecko installation is properly configured"""
        # Cache system check result if not provided
        if has_system_gecko is None:
            has_system_gecko = self.check_system_gecko()
            
        print("\nPerforming Gecko verification...")
        verification_passed = True

        # Always check registry
        print("\nChecking MSHTML registry:")
        try:
            result = self.run_command(
                ["wine", "reg", "query", "HKLM\\Software\\Wine\\MSHTML"],
                timeout=10
            )
            print(f"  {'✓' if result == 0 else '✗'} MSHTML registry key {'found' if result == 0 else 'not found'}")
            if result != 0:
                verification_passed = False
        except Exception as e:
            print(f"  ✗ Error checking registry: {e}")
            verification_passed = False

        # Always check critical paths
        print("\nChecking critical Gecko paths:")
        critical_paths = [
            os.path.join(self.prefix_path, "drive_c/windows/system32/gecko"),
            os.path.join(self.prefix_path, "drive_c/windows/syswow64/gecko"),
            os.path.join(self.prefix_path, "drive_c/windows/system32/mshtml.dll"),
            os.path.join(self.prefix_path, "drive_c/windows/syswow64/mshtml.dll")
        ]
        
        for path in critical_paths:
            exists = os.path.exists(path)
            print(f"  {'✓' if exists else '✗'} {path}")
            if not exists:
                verification_passed = False

        print(f"\nGecko verification {'passed' if verification_passed else 'failed'} all checks")
        return verification_passed

    def setup_prefix(self, install_dxvk=True):
        """Set up and configure the Wine prefix with all requirements"""
        self.suppress_gui()
        if not self.check_wine_installed():
            raise WineSetupError("Wine is not installed or not accessible from the command line.")

        os.makedirs(self.prefix_path, exist_ok=True)

        #add windowing associate
        self.run_command([
        "wine", "reg", "add", "HKCU\\Software\\Wine\\X11 Driver",
        "/v", "Managed", "/t", "REG_SZ", "/d", "Y", "/f"
        ])

        # Initialize new prefix if needed
        if not os.path.exists(os.path.join(self.prefix_path, "system.reg")):
            print("Initializing new Wine prefix...")
            print("Running wineboot initialization...")
            if self.run_command(["wineboot", "-u", "-i"], timeout=60) != 0:
                print("Warning: wineboot initialization may have failed")
                        
            self.run_command(["wineserver", "-k"], timeout=10)
            print("SKIPPING WINDOWS 7 CONFIG STEPS, let pso.bat do it")

        # Handle Mono installation
        has_system_mono = self.check_system_mono()
        if self._verify_mono_installation(has_system_mono):
            print("Mono is already configured in the prefix.")
        elif has_system_mono:
            print("System-wide Mono detected, configuring prefix...")
            if not self.install_mono(has_system_mono):
                print("Warning: Failed to configure system Mono.")
                return False
        else:
            print("No system Mono detected, installing in prefix...")
            if not self.install_mono(has_system_mono):
                print("Warning: Failed to install Mono. You may need to install using your package manager:")
                print("  Debian/Ubuntu: sudo apt install wine-mono")
                print("  Arch Linux: sudo pacman -S wine-mono")
                print("  Fedora: sudo dnf install wine-mono")
                return False

        # Check Gecko - streamlined like DXVK
        has_system_gecko = self.check_system_gecko()
        if has_system_gecko:
            print("System-wide Wine Gecko detected.")
            if not self._verify_gecko_installation(has_system_gecko):
                print("Configuring system Gecko in prefix...")
                if not self.install_gecko(has_system_gecko):
                    print("Warning: Failed to configure system Gecko.")
                    return False
        else:
            print("No system Wine Gecko detected, checking prefix installation...")
            if not self._verify_gecko_installation(has_system_gecko):
                print("Installing Gecko in prefix...")
                if not self.install_gecko(has_system_gecko):
                    print("Warning: Failed to install Wine Gecko. You may need to install using your package manager:")
                    print("  Debian/Ubuntu: sudo apt install wine-gecko")
                    print("  Arch Linux: sudo pacman -S wine-gecko")
                    print("  Fedora: sudo dnf install wine-gecko")
                    return False

        if install_dxvk:
            # Check DXVK status once and store the result
            has_system_dxvk = self.check_system_dxvk()
            
            if self._verify_dxvk_installation(has_system_dxvk):
                print("DXVK is already installed in the prefix.")
            elif has_system_dxvk:
                print("System-wide DXVK installation detected, configuring prefix...")
                if not self.install_dxvk(has_system_dxvk):
                    print("Warning: Failed to configure system DXVK.")
                    return False
            else:
                print("No DXVK installation found. Installing in prefix...")
                if not self.install_dxvk(has_system_dxvk):
                    print("Warning: Failed to install DXVK. You may need to install using your package manager:")
                    print("  Debian/Ubuntu: sudo apt install dxvk")
                    print("  Arch Linux: yay -S dxvk-bin")
                    print("  Fedora: sudo dnf install dxvk")
                    return False

        print("All components installed successfully!")
        return True

    
    def get_system_package_manager(self):
        """Detect the system's package manager"""
        if platform.system() != "Linux":
            return None
            
        # Check for common package managers
        package_managers = {
            "pacman": "pacman",
            "apt": "dpkg",
            "dnf": "rpm",
            "yum": "rpm"
        }
        
        for cmd, pm_type in package_managers.items():
            try:
                if self.run_command(["which", cmd], timeout=10) == 0:
                    return pm_type
            except Exception:
                continue
                
        return None
    
    def check_package_installed(self, package_name):
        """Check if a package is installed using the appropriate package manager"""
        pm = self.get_system_package_manager()
        if not pm:
            return False
            
        try:
            if pm == "pacman":
                result = self.run_command(["pacman", "-Qi", package_name], timeout=10)
            elif pm == "dpkg":
                result = self.run_command(["dpkg", "-s", package_name], timeout=10)
            elif pm == "rpm":
                result = self.run_command(["rpm", "-q", package_name], timeout=10)
            return result == 0
        except Exception:
            return False
    
    def check_system_dxvk(self):
        """Check if DXVK is installed system-wide"""
        possible_paths = [
            "/usr/share/dxvk",
            "/usr/lib/dxvk",
            "/usr/local/share/dxvk",
        ]
        
        # Check package managers
        package_name = "dxvk-bin" if self.get_system_package_manager() == "pacman" else "dxvk"
        if self.check_package_installed(package_name):
            print("Found dxvk system package installed")
            return True

        # Check system paths as fallback
        return any(pathlib.Path(path).exists() for path in possible_paths)

    def install_dxvk(self, has_system_dxvk=None):
        """Install DXVK in the prefix. Use system DXVK if available, otherwise download."""
        DEV_MODE = True
        cache_dir = self.get_cache_dir()
        os.makedirs(cache_dir, exist_ok=True)

        # No need to check again - use the passed value
        override_setting = "native" if has_system_dxvk else "native,builtin"
        
        if has_system_dxvk:
            print("Using system DXVK installation...")
            setup_paths = [
                "/usr/share/dxvk/setup_dxvk.sh",
                "/usr/bin/setup_dxvk",
                "/usr/local/bin/setup_dxvk"
            ]
            
            setup_script = next((path for path in setup_paths if os.path.exists(path)), None)
            
            if setup_script:
                print(f"Found DXVK setup script at {setup_script}")
                try:
                    result = self.run_command([setup_script, "install"], timeout=30)
                    if result == 0 and self._verify_dxvk_installation(has_system_dxvk):
                        print("System DXVK setup completed successfully!")
                        return True
                    print(f"DXVK setup script failed or verification failed")
                except Exception as e:
                    print(f"Error running DXVK setup script: {e}")
            else:
                print("No system DXVK setup script found!")

            print("System DXVK setup failed, falling back to manual installation...")

        # Manual installation from GitHub
        try:
            dxvk_version = "2.3"
            dxvk_filename = f"dxvk-{dxvk_version}.tar.gz"
            dxvk_url = f"https://github.com/doitsujin/dxvk/releases/download/v{dxvk_version}/{dxvk_filename}"
            dxvk_path = os.path.join(cache_dir, dxvk_filename)

            print(f"Installing DXVK {dxvk_version} from GitHub...")
            
            # Download and verify archive
            have_valid_archive = os.path.exists(dxvk_path) and os.path.getsize(dxvk_path) >= 1024
            if DEV_MODE and have_valid_archive:
                print(f"Using existing DXVK archive at {dxvk_path}")
            else:
                if have_valid_archive:
                    os.remove(dxvk_path)
                if not self.download_file(dxvk_url, dxvk_path):
                    raise Exception("Failed to download DXVK archive")

            # Extract and install DXVK
            print("Extracting DXVK...")
            extract_dir = os.path.join(cache_dir, f"dxvk-{dxvk_version}")
            if os.path.exists(extract_dir):
                shutil.rmtree(extract_dir)
                
            with tarfile.open(dxvk_path, "r:gz") as tar:
                tar.extractall(cache_dir)

            # Install the DLLs
            dll_paths = {
                "x32": os.path.join(extract_dir, "x32"),
                "x64": os.path.join(extract_dir, "x64")
            }

            for arch, dll_dir in dll_paths.items():
                if os.path.exists(dll_dir):
                    for dll in ["d3d9.dll", "d3d10core.dll", "d3d11.dll", "dxgi.dll", "d3d8"]:
                        dll_path = os.path.join(dll_dir, dll)
                        if os.path.exists(dll_path):
                            target_dir = os.path.join(self.prefix_path, 
                                                    "drive_c/windows/system32" if arch == "x64" else "drive_c/windows/syswow64")
                            os.makedirs(target_dir, exist_ok=True)
                            shutil.copy2(dll_path, target_dir)
                            print(f"Installed {dll} to {target_dir}")

            # Set DLL overrides once with correct override_setting
            override_dlls = ["d3d9", "d3d10core", "d3d11", "dxgi", "d3d8"]
            for dll in override_dlls:
                self.run_command([
                    "wine", "reg", "add", "HKEY_CURRENT_USER\\Software\\Wine\\DllOverrides",
                    "/v", dll, "/d", override_setting, "/f"
                ], timeout=10)

            if self._verify_dxvk_installation(has_system_dxvk):
                print("DXVK installation completed and verified successfully!")
                return True
                
            raise Exception("DXVK installation verification failed")

        except Exception as e:
            print(f"Manual DXVK installation failed: {e}")
            return False
        
    def check_prefix_dxvk(self):
        """Check if DXVK is installed in the prefix"""
        #useless function. remove later
        return self._verify_dxvk_installation()

    def _verify_dxvk_installation(self, has_system_dxvk):
        """Verify DXVK installation actually installed"""
        # Use the system DXVK check result to determine expected override setting
        
        #convoluted but eh
        if has_system_dxvk is None:
            has_system_dxvk = self.check_system_dxvk()
            
        expected_override = "native" if has_system_dxvk else "native,builtin"
        print(f"Checking {'system' if has_system_dxvk else 'local'} DXVK installation (expecting '{expected_override}' overrides)...")
    
        # Check DXVK DLLs in both 32-bit and 64-bit system directories
        dll_list = ["d3d9.dll", "d3d10core.dll", "d3d11.dll", "dxgi.dll"]
        dll_paths = {
            "system32": os.path.join(self.prefix_path, "drive_c/windows/system32"),
            "syswow64": os.path.join(self.prefix_path, "drive_c/windows/syswow64")
        }
        
        print("Checking DXVK DLLs:")
        all_dlls_present = True
        for dir_name, dir_path in dll_paths.items():
            for dll in dll_list:
                dll_path = os.path.join(dir_path, dll)
                exists = os.path.exists(dll_path)
                print(f"  {'✓' if exists else '✗'} {dir_name}/{dll}")
                if not exists:
                    all_dlls_present = False
                    
        if not all_dlls_present and not has_system_dxvk:
            print("Missing required DXVK DLLs")
            return False
                    
        # Check DLL overrides in registry
        try:
            result = self.run_command(
                ["wine", "reg", "query", "HKEY_CURRENT_USER\\Software\\Wine\\DllOverrides"],
                timeout=10
            )
            
            if result == 0:
                required_dlls = {"d3d9", "d3d10core", "d3d11", "dxgi"}
                found_dlls = set()
                
                for dll in required_dlls:
                    dll_result = self.run_command([
                        "wine", "reg", "query", 
                        "HKEY_CURRENT_USER\\Software\\Wine\\DllOverrides",
                        "/v", dll
                    ], timeout=10)
                    
                    if dll_result == 0:
                        found_dlls.add(dll)
                
                missing_dlls = required_dlls - found_dlls
                if missing_dlls:
                    print(f"Missing DLL overrides for: {', '.join(missing_dlls)}")
                    print(f"Note: Looking for '{expected_override}' override setting")
                    return False
            else:
                print("Failed to query DLL overrides")
                return False
        except Exception as e:
            print(f"Error checking DLL overrides: {e}")
            return False

        print("DXVK verification successful - all files and registry entries present")
        return True

    def cleanup_prefix(self):
        """Remove the Wine prefix directory"""
        if os.path.exists(self.prefix_path):
            # First kill any wine processes
            self.run_command(["wineserver", "-k"], timeout=10)
            # Then remove the prefix
            shutil.rmtree(self.prefix_path)